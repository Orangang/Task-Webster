<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Task Webster · Дашборд</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F5F7FB; --shell:#fff; --text:#0B1220; --muted:#6B7380;
  --line:#E6E9F0; --line-strong:#D6DAE3; --accent:#0B82DD; --accent-dark:#0A66B2;
  --tag-bg:#F4F7FE; --tag-line:#E6EBFA;
  --radius:12px; --shadow:0 8px 24px rgba(12,22,44,.06);
  --fs-xs:clamp(11px,.78vw,12px); --fs-sm:clamp(12px,.9vw,14px); --fs-md:clamp(14px,1.05vw,16px); --fs-lg:clamp(16px,1.25vw,18px);
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:400 var(--fs-md)/1.5 "Inter",system-ui;display:flex;flex-direction:column}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:var(--shell);box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#7aa7ff,#5ec8ff)}
header h1{font-size:var(--fs-lg);margin:0}
header .right{display:flex;gap:10px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line-strong);border-radius:var(--radius);background:#fff;font-weight:600;cursor:pointer}
.btn.primary{background:var(--accent);border-color:transparent;color:#fff}
.btn.primary:hover{background:var(--accent-dark)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:var(--tag-bg);border:1px solid var(--tag-line);font-size:var(--fs-xs)}

/* Layout */
main{flex:1;display:grid;grid-template-columns:280px 1fr;gap:24px;padding:24px}
.sidebar{background:var(--shell);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:16px}
.sidebar h2{margin:0 0 4px;font-size:var(--fs-md)}
.search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:10px}
.search input{border:none;outline:none;background:transparent;width:100%}
.projects{display:flex;flex-direction:column;gap:8px;overflow:auto}
.project{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.project.active{border-color:var(--accent);outline:2px solid rgba(11,130,221,.15)}
.project:hover{border-color:var(--accent)}
.proj-actions{display:flex;gap:6px}
.xs{padding:4px 8px;font-size:var(--fs-xs)}
.addBtn{border:1px dashed var(--line-strong);background:#fff;border-radius:10px;padding:10px;text-align:center;font-weight:600;cursor:pointer}
.addBtn:hover{background:#eef6ff;border-color:#b9d6ff}

.content{background:var(--shell);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;display:flex;flex-direction:column;gap:12px}
.toolbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
.breadcrumb{color:var(--muted)}
.group{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;margin-top:8px}
.group-h{display:flex;gap:10px;align-items:center;padding:12px 14px;background:#FAFBFE;border-bottom:1px solid var(--line)}
.dot{width:8px;height:8px;border-radius:50%}
.rows{display:flex;flex-direction:column}
.row-h,.row{display:grid;grid-template-columns:1.6fr 1.2fr .9fr .9fr 120px;gap:8px;align-items:center}
.row-h{padding:10px 14px;color:var(--muted);background:#fff}
.row{padding:10px 14px;border-top:1px solid var(--line);background:#fff}
.row:hover{background:#fafcff}
.row select,.row input[type="date"]{padding:6px;border:1px solid var(--line);border-radius:8px;background:#fff}
.del{justify-self:end}
.empty{color:var(--muted);font-size:var(--fs-sm);padding:10px 14px}

/* Responsive */
@media(max-width:960px){main{grid-template-columns:1fr;gap:16px;padding:16px}}
@media(max-width:640px){.row-h,.row{grid-template-columns:1.6fr 1fr .9fr 120px}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div><h1>Task Webster</h1>
  </div>
  <div class="right">
    <span id="userEmail" class="badge">—</span>
    <button id="logout" class="btn primary">Выйти</button>
  </div>
</header>

<main>
  <!-- Сайдбар проектов -->
  <aside class="sidebar">
    <h2>Проекты</h2>
    <div class="search"><input id="projSearch" placeholder="Поиск проектов…"></div>
    <div id="projects" class="projects" aria-live="polite"></div>
    <div id="newProject" class="addBtn">+ Новый проект</div>
    <!-- Подсказка по БД -->
    <div class="badge" title="projects / tasks в Supabase">Сохранение — Supabase</div>
  </aside>

  <!-- Контент задач -->
  <section class="content">
    <div class="toolbar">
      <div class="breadcrumb" id="crumb">Мои страницы › <b>Выберите проект</b></div>
      <div style="display:flex;gap:8px">
        <button id="createTask" class="btn primary">+ Новая задача</button>
      </div>
    </div>
    <div id="taskWrap"></div>
  </section>
</main>

<footer style="text-align:center;color:var(--muted);padding:12px 0;font-size:var(--fs-sm)">
  © 2025 · Webster · <a href="#" style="color:inherit;text-decoration:none">Политика конфиденциальности</a> · <a href="#" style="color:inherit;text-decoration:none">Пользовательское соглашение</a>
</footer>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ===== Конфиг Supabase (твой проект) ===== */
const SUPABASE_URL="https://aayobnsqgzsmhwbtutyw.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFheW9ibnNxZ3pzbWh3YnR1dHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDkxNDEsImV4cCI6MjA3NzA4NTE0MX0.dNC_rYVPLk3etb2njI3agDE7wmmu4HQyBrkiyZ4ifoA";
const supa = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ===== Справка по БД (создай один раз в Supabase SQL):
-- projects
create table if not exists projects(
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null,
  name text not null,
  key text,
  created_at timestamp with time zone default now()
);
-- tasks
create table if not exists tasks(
  id uuid primary key default gen_random_uuid(),
  project_id uuid not null references projects(id) on delete cascade,
  user_id uuid not null,
  title text not null,
  status text not null default 'todo', -- todo|progress|review|done
  priority text not null default 'medium', -- low|medium|high|urgent
  due_at date,
  description text,
  created_at timestamp with time zone default now()
);
Политика RLS (включить) + policy:
  for select/insert/update/delete using (auth.uid() = user_id)
============================================== */

/* ===== Локализация статусов ===== */
const STATUS={
  todo:{label:"К выполнению",color:"#9aa4b2"},
  progress:{label:"В работе",color:"#5B8DEF"},
  review:{label:"На проверке",color:"#F1C40F"},
  done:{label:"Готово",color:"#84d9a2"}
};
const PRIORITY_LABEL={low:"низкий",medium:"средний",high:"высокий",urgent:"срочно"};

/* ===== Глобальное состояние ===== */
const state={ user:null, projects:[], tasks:[], currentProjectId:null };

/* ===== Утилиты ===== */
const $=s=>document.querySelector(s);
function el(html){const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstElementChild;}
function byId(arr,id){return arr.find(x=>x.id===id);}

/* ===== Gate: без сессии → login.html ===== */
(async function gate(){
  const { data:{ session } } = await supa.auth.getSession();
  if(!session){ localStorage.removeItem('tw_user'); location.href='./login.html'; return; }
  state.user={id:session.user.id,email:session.user.email};
  $("#userEmail").textContent=state.user.email||"—";
  await loadProjects();
})();

/* ===== Выход ===== */
$("#logout").onclick=async()=>{ await supa.auth.signOut(); localStorage.removeItem('tw_user'); location.href='./login.html'; };

/* ===== Загрузка данных ===== */
async function loadProjects(){
  const {data,error}=await supa.from("projects").select("*").eq("user_id",state.user.id).order("created_at",{ascending:false});
  if(error){alert("Ошибка загрузки проектов: "+error.message);return;}
  state.projects=data||[];
  renderProjects();
  // Открыть последний выбранный проект (из localStorage)
  const last = localStorage.getItem('tw_last_project');
  if(last && byId(state.projects,last)){ openProject(last); }
}

async function loadTasks(pid){
  const {data,error}=await supa.from("tasks").select("*").eq("project_id",pid).order("created_at",{ascending:false});
  if(error){alert("Ошибка загрузки задач: "+error.message);return;}
  state.tasks=data||[];
}

/* ===== Рендер проектов ===== */
function renderProjects(filter=""){
  const wrap=$("#projects"); wrap.innerHTML="";
  const list = state.projects.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase()));
  if(!list.length){wrap.append(el(`<div class="empty">Проектов нет</div>`)); return;}
  list.forEach(p=>{
    const item=el(`<div class="project" data-id="${p.id}">
      <span>${p.name}</span>
      <div class="proj-actions">
        <button class="btn xs" data-act="rename">Переимен.</button>
        <button class="btn xs" data-act="del">Удалить</button>
      </div>
    </div>`);
    if(p.id===state.currentProjectId) item.classList.add("active");
    item.addEventListener("click",(e)=>{ if(e.target.dataset.act) return; openProject(p.id); });
    item.querySelector('[data-act="rename"]').onclick=async(e)=>{
      e.stopPropagation();
      const name=prompt("Новое имя проекта:",p.name); if(!name||name===p.name) return;
      const {error}=await supa.from("projects").update({name}).eq("id",p.id);
      if(error) return alert("Не удалось переименовать: "+error.message);
      p.name=name; renderProjects($("#projSearch").value); if(p.id===state.currentProjectId) $("#crumb").innerHTML=`Мои страницы › <b>${p.name}</b>`;
    };
    item.querySelector('[data-act="del"]').onclick=async(e)=>{
      e.stopPropagation();
      if(!confirm("Удалить проект и все его задачи?")) return;
      const {error}=await supa.from("projects").delete().eq("id",p.id);
      if(error) return alert("Не удалось удалить: "+error.message);
      state.projects=state.projects.filter(x=>x.id!==p.id);
      if(state.currentProjectId===p.id){ state.currentProjectId=null; $("#taskWrap").innerHTML=""; $("#crumb").innerHTML=`Мои страницы › <b>Выберите проект</b>`; }
      renderProjects($("#projSearch").value);
    };
    wrap.append(item);
  });
}

/* ===== Создание проекта ===== */
$("#newProject").onclick=async()=>{
  const name=prompt("Название проекта?"); if(!name) return;
  const key=name.split(/\s+/).map(s=>s[0]).join("").slice(0,3).toUpperCase();
  const {data,error}=await supa.from("projects").insert({name,key,user_id:state.user.id}).select().single();
  if(error){alert("Не удалось создать проект: "+error.message);return;}
  state.projects.unshift(data); renderProjects($("#projSearch").value); openProject(data.id);
};

/* ===== Открыть проект ===== */
async function openProject(pid){
  state.currentProjectId=pid; localStorage.setItem('tw_last_project',pid);
  document.querySelectorAll(".project").forEach(n=>n.classList.toggle("active",n.dataset.id===pid));
  const p=byId(state.projects,pid); $("#crumb").innerHTML=`Мои страницы › <b>${p?.name||"Проект"}</b>`;
  await loadTasks(pid); renderTasks();
}

/* ===== Рендер задач (группы по статусу) ===== */
function renderTasks(){
  const wrap=$("#taskWrap"); wrap.innerHTML="";
  if(!state.currentProjectId){ wrap.append(el(`<div class="empty">Сначала выберите проект</div>`)); return; }

  const list=el(`<div class="rows"></div>`);
  const groups=Object.keys(STATUS);

  // Заголовок таблицы
  list.append(el(`<div class="row-h"><div>Задача</div><div>Статус</div><div>Приоритет</div><div>Срок</div><div>Действия</div></div>`));

  // По группам рендерим блоки
  groups.forEach(g=>{
    const items=state.tasks.filter(t=>t.status===g);
    const sec=el(`<section class="group" data-group="${g}">
      <div class="group-h"><div class="dot" style="background:${STATUS[g].color}"></div><b>${STATUS[g].label.toUpperCase()}</b><span class="badge" style="margin-left:auto"><span data-count>${items.length}</span></span></div>
      <div class="rows" data-rows></div>
    </section>`);
    const body=sec.querySelector("[data-rows]");
    if(!items.length) body.append(el(`<div class="empty">Пусто</div>`));
    items.forEach(t=>body.append(taskRow(t)));
    wrap.append(sec);
  });

  // Действия внутри списка
  wrap.onchange=async(e)=>{
    const f=e.target.dataset.field, id=e.target.dataset.id; if(!f||!id) return;
    const val=(f==="due_at")?(e.target.value||null):e.target.value;
    const i=state.tasks.findIndex(t=>t.id===id); if(i>-1) state.tasks[i]={...state.tasks[i],[f]:val};
    try{ await supa.from("tasks").update({[f]:val}).eq("id",id); }catch(err){ alert("Ошибка сохранения: "+err.message); return; }
    // Мгновенное перемещение при смене статуса
    if(f==="status"){ moveRowInstant(e.target.closest(".row"), val); }
  };

  wrap.onclick=async(e)=>{
    const id=e.target.dataset.del; if(!id) return;
    if(!confirm("Удалить задачу?")) return;
    try{ await supa.from("tasks").delete().eq("id",id); }catch(err){ return alert("Ошибка удаления: "+err.message); }
    state.tasks=state.tasks.filter(t=>t.id!==id);
    const row=e.target.closest(".row"); const sec=row.closest(".group");
    row.remove(); updateGroupCount(sec);
    if(!sec.querySelector(".row")) sec.querySelector("[data-rows]").innerHTML='<div class="empty">Пусто</div>';
  };
}

/* ===== Создание задачи ===== */
$("#createTask").onclick=async()=>{
  if(!state.currentProjectId) return alert("Сначала выберите проект");
  const title=prompt("Заголовок задачи?"); if(!title) return;
  const payload={project_id:state.currentProjectId,user_id:state.user.id,title,status:"todo",priority:"medium",due_at:null,description:""};
  const {data,error}=await supa.from("tasks").insert(payload).select().single();
  if(error){alert("Не удалось создать: "+error.message);return;}
  state.tasks.unshift(data);

  // Мгновенно добавим в DOM (группа todo)
  const todo=document.querySelector('.group[data-group="todo"] [data-rows]');
  if(todo){ if(todo.querySelector(".empty")) todo.innerHTML=""; todo.prepend(taskRow(data)); updateGroupCount(todo.closest(".group")); }
};

/* ===== Строка задачи ===== */
function taskRow(t){
  return el(`<div class="row" data-id="${t.id}">
    <div>${t.title}</div>
    <div>
      <select data-id="${t.id}" data-field="status">
        ${Object.keys(STATUS).map(s=>`<option value="${s}" ${s===t.status?'selected':''}>${STATUS[s].label}</option>`).join('')}
      </select>
    </div>
    <div>
      <select data-id="${t.id}" data-field="priority">
        ${['low','medium','high','urgent'].map(s=>`<option value="${s}" ${s===t.priority?'selected':''}>${PRIORITY_LABEL[s]}</option>`).join('')}
      </select>
    </div>
    <div><input type="date" data-id="${t.id}" data-field="due_at" value="${t.due_at||''}"></div>
    <div class="del"><button class="btn xs" data-del="${t.id}">Удалить</button></div>
  </div>`);
}

/* ===== Перемещение строки по DOM и обновление счётчиков ===== */
function moveRowInstant(row, toStatus){
  const wrap=document.querySelector(`.group[data-group="${toStatus}"] [data-rows]`);
  const fromGroup=row.closest(".group");
  if(wrap){
    if(wrap.querySelector(".empty")) wrap.innerHTML="";
    wrap.prepend(row);
    updateGroupCount(fromGroup);
    updateGroupCount(wrap.closest(".group"));
    if(!fromGroup.querySelector(".row")) fromGroup.querySelector("[data-rows]").innerHTML='<div class="empty">Пусто</div>';
  }
}
function updateGroupCount(sec){ sec.querySelector("[data-count]").textContent=sec.querySelectorAll(".row").length; }

/* ===== Поиск по проектам ===== */
$("#projSearch").oninput=(e)=>{ renderProjects(e.target.value.trim()); };
</script>
</body>
</html>
